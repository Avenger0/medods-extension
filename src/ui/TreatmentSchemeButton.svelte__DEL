<!-- src/ui/TreatmentSchemeButton.svelte -->
<script>
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    import ExistingSchemes from './ExistingSchemes.svelte';
    import CreateSchemeButton from './CreateSchemeButton.svelte';
    import TreatmentModal from './TreatmentModal.svelte';
    
    export let serviceId = null;
    export let medicalCardId = null;
    
    // –°—Ç–∏–ª–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏
    // –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–∞–ª–∫–∞
    export let modalMaxWidth = '1100px';
    export let modalBgColor = 'white';
    export let modalBorderRadius = '8px';
    export let modalOverlayColor = 'rgba(0,0,0,0.5)';
    
    // –°–ø–∏—Å–æ–∫ —Å—Ö–µ–º
    export let schemesBgColor = '#f8f9fa';
    export let schemesTitleColor = '#333';
    export let schemesBorderColor = '#e9ecef';
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ö–µ–º
    export let schemeItemBgColor = '#f8f9fa';
    export let schemeItemHoverColor = '#e9ecef';
    export let schemeItemBorderColor = '#e9ecef';
    export let schemeTitleColor = '#333';
    export let schemeDetailsColor = '#6c757d';
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å–æ —Å—Ö–µ–º–∞–º–∏
    export let useButtonBgColor = '#007bff';
    export let useButtonTextColor = '#fff';
    export let editButtonBgColor = '#6c757d';
    export let editButtonTextColor = '#fff';
    
    // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã
    export let createButtonBgColor = '#28a745';
    export let createButtonTextColor = '#fff';
    export let createButtonHoverColor = '#218838';
    export let createButtonBorderRadius = '4px';
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Å–Ω–æ–≤–Ω–∞—è
    export let mainButtonBgColor = '#007bff';
    export let mainButtonTextColor = 'white';
    export let mainButtonBorderRadius = '4px';
    
    let isModalOpen = false;
    let isCreatingNewScheme = false;
    let medications = [
        { id: 1, name: '–¶–µ—Ñ—Ç—Ä–∏–∞–∫—Å–æ–Ω', type: '–≤/–º' },
        { id: 2, name: '–ú–µ—Ç—Ä–æ–Ω–∏–¥–∞–∑–æ–ª', type: '–≤/–≤' },
        { id: 3, name: '–ò–±—É–ø—Ä–æ—Ñ–µ–Ω', type: '–≤/–º' }
    ];

    let validationError = '';
    let isLoading = false;

    let medicationForm = {
        medication: medications[0],
        administrationType: '–≤/–º',
        dosage: '',
        hasDiluent: '–Ω–µ—Ç',
        diluents: [] // –ú–∞—Å—Å–∏–≤ —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª–µ–π –≤–º–µ—Å—Ç–æ –µ–¥–∏–Ω–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π
    };
    
    let editingMedicationId = null;
    let currentEditingScheme = null;

    let selectedMedications = [];
    let selectedDays = {};

    let existingSchemes = [
        { 
            id: 1, 
            name: '–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è ‚Ññ1', 
            medications: [
                { 
                    id: 101, 
                    name: '–¶–µ—Ñ—Ç—Ä–∏–∞–∫—Å–æ–Ω', 
                    dosage: '1–≥', 
                    –∞–¥–º–∏–Ω–∏—Å—Ç—ÄationType: '–≤/–º',
                    diluents: [
                        { id: 1001, type: '—Ñ–∏–∑—Ä–∞—Å—Ç–≤–æ—Ä', dosage: '2–º–ª' }
                    ]
                }
            ],
            schedule: {
                101: { 1: [1, 3, 5, 7, 9] }
            }
        },
        { 
            id: 2, 
            name: '–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è ‚Ññ2', 
            medications: [
                { 
                    id: 201, 
                    name: '–ú–µ—Ç—Ä–æ–Ω–∏–¥–∞–∑–æ–ª', 
                    dosage: '500–º–≥', 
                    –∞–¥–º–∏–Ω–∏—Å—Ç—ÄationType: '–≤/–≤',
                    diluents: [
                        { id: 2001, type: '–≥–ª—é–∫–æ–∑–∞', dosage: '100–º–ª' },
                        { id: 2002, type: '—Ñ–∏–∑—Ä–∞—Å—Ç–≤–æ—Ä', dosage: '50–º–ª' }
                    ]
                }
            ],
            schedule: {
                201: { 1: [1, 2, 3, 4, 5] }
            }
        }
    ];

    $: isScheduleValid = selectedMedications.length > 0 && 
    selectedMedications.every(medication => 
        selectedDays[medication.id] && 
        Object.values(selectedDays[medication.id]).some(daySet => daySet.size > 0)
    );

    // –†–µ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—ã
    $: isFormValid = !!(
        medicationForm.medication &&
        medicationForm.administrationType &&
        medicationForm.dosage &&
        (medicationForm.hasDiluent === '–Ω–µ—Ç' || 
        (medicationForm.hasDiluent === '–¥–∞' && 
        medicationForm.diluents.length > 0 && 
        medicationForm.diluents.every(d => d.type && d.dosage)))
    );

    function addDiluent() {
        medicationForm.diluents = [
            ...medicationForm.diluents,
            { id: Date.now(), type: '', dosage: '' }
        ];
    }

    function editMedication(medication) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
        medicationForm = {
            medication: medications.find(m => m.name === medication.medication.name) || medications[0],
            administrationType: medication.administrationType,
            dosage: medication.dosage,
            hasDiluent: medication.hasDiluent,
            diluents: [...medication.diluents]
        };
        
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
        editingMedicationId = medication.id;
    }

    function deleteMedication(medicationId) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–ø–∞—Ä–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
        selectedMedications = selectedMedications.filter(med => med.id !== medicationId);
        
        // –£–¥–∞–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
        if (selectedDays[medicationId]) {
            delete selectedDays[medicationId];
            selectedDays = {...selectedDays}; // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–æ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è
        if (editingMedicationId === medicationId) {
            resetMedicationForm();
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        validationError = '';
    }

    function removeDiluent(id) {
        medicationForm.diluents = medicationForm.diluents.filter(d => d.id !== id);
    }

    function toggleModal() {
        isModalOpen = !isModalOpen;
        if (!isModalOpen) {
            resetState();
        }
    }

    function resetState() {
        medicationForm = {
            medication: medications[0],
            administrationType: '–≤/–º',
            dosage: '',
            hasDiluent: '–Ω–µ—Ç',
            diluents: []
        };
        selectedMedications = [];
        selectedDays = {};
        isCreatingNewScheme = false;
        currentEditingScheme = null;
        validationError = '';
    }

    function addMedication() {
        if (isFormValid) {
            if (editingMedicationId) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                selectedMedications = selectedMedications.map(med => {
                    if (med.id === editingMedicationId) {
                        return {
                            ...medicationForm,
                            id: med.id
                        };
                    }
                    return med;
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                editingMedicationId = null;
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                const newMedication = { 
                    ...medicationForm,
                    id: Date.now() // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
                };
                
                selectedMedications = [...selectedMedications, newMedication];
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            resetMedicationForm();
        }
    }

    function resetMedicationForm() {
        medicationForm = {
            medication: medications[0],
            administrationType: '–≤/–º',
            dosage: '',
            hasDiluent: '–Ω–µ—Ç',
            diluents: []
        };
        editingMedicationId = null;
    }

    function toggleDay(medicationId, week, day) {
        if (!selectedDays[medicationId]) {
            selectedDays[medicationId] = {};
        }
        
        if (!selectedDays[medicationId][week]) {
            selectedDays[medicationId][week] = new Set();
        }

        if (selectedDays[medicationId][week].has(day)) {
            selectedDays[medicationId][week].delete(day);
        } else {
            selectedDays[medicationId][week].add(day);
        }

        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        selectedDays = {...selectedDays};

        validationError = '';
    }

    function selectExistingScheme(scheme) {
        console.log('–í—ã–±—Ä–∞–Ω–∞ —Å—Ö–µ–º–∞:', scheme);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ö–µ–º—ã –≤ —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è
        selectedMedications = scheme.medications.map(med => {
            const medId = med.id || Date.now() + Math.random();
            
            return {
                id: medId,
                medication: { name: med.name },
                administrationType: med.–∞–¥–º–∏–Ω–∏—Å—Ç—ÄationType,
                dosage: med.dosage,
                hasDiluent: med.diluents && med.diluents.length > 0 ? '–¥–∞' : '–Ω–µ—Ç',
                diluents: med.diluents || []
            };
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        selectedDays = {};
        
        if (scheme.schedule) {
            Object.entries(scheme.schedule).forEach(([medId, weeks]) => {
                selectedDays[medId] = {};
                
                Object.entries(weeks).forEach(([week, days]) => {
                    selectedDays[medId][week] = new Set(days);
                });
            });
        }
        
        isCreatingNewScheme = true;
        toggleModal();
        validationError = '';
    }

    function startNewScheme() {
        isCreatingNewScheme = true;
        selectedMedications = [];
        selectedDays = {};
        validationError = '';
    }

    function publishTreatmentScheme() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        const medicationsWithoutSchedule = selectedMedications.filter(medication => 
            !selectedDays[medication.id] || 
            !Object.values(selectedDays[medication.id]).some(daySet => daySet.size > 0)
        );

        if (medicationsWithoutSchedule.length > 0) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            const medicationNames = medicationsWithoutSchedule.map(med => med.medication.name).join(', ');
            validationError = `–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–Ω—è –¥–ª—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤: ${medicationNames}`;
            return;
        }
        try {
            isLoading = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Set –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
            const formattedSchedule = {};
            
            Object.entries(selectedDays).forEach(([medId, weeks]) => {
                formattedSchedule[medId] = {};
                
                Object.entries(weeks).forEach(([week, days]) => {
                    formattedSchedule[medId][week] = Array.from(days);
                });
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã –∏–ª–∏ —Ä–µ–¥–∞–∫—Ü–∏–∏
            const newScheme = {
                id: Date.now(),
                name: currentEditingScheme 
                    ? `${currentEditingScheme.name} (—Ä–µ–¥–∞–∫—Ü–∏—è –æ—Ç ${new Date().toLocaleDateString()})` 
                    : `–°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è –æ—Ç ${new Date().toLocaleDateString()}`,
                medications: selectedMedications.map(med => ({
                    id: med.id,
                    name: med.medication.name,
                    dosage: med.dosage,
                    –∞–¥–º–∏–Ω–∏—Å—Ç—ÄationType: med.administrationType,
                    hasDiluent: med.hasDiluent,
                    diluent: med.diluent,
                    diluentDosage: med.diluentDosage
                })),
                createdFor: {
                    serviceId,
                    medicalCardId
                },
                createdAt: new Date().toISOString(),
                isRevision: !!currentEditingScheme,
                originalSchemeId: currentEditingScheme ? currentEditingScheme.id : null,
                schedule: formattedSchedule
            };
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç API-–∑–∞–ø—Ä–æ—Å)
            setTimeout(() => {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º—ã
                existingSchemes = [...existingSchemes, newScheme];
                
                console.log('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è', newScheme);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                isLoading = false;
                
                // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                toggleModal();
            }, 1000); // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ 1 —Å–µ–∫—É–Ω–¥—É
            
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å—Ö–µ–º—ã:', err);
            isLoading = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        }
    }

    function editExistingScheme(scheme) {
        console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã:', scheme);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ —Å—Ö–µ–º—ã
        selectedMedications = scheme.medications.map(med => {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ID –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
            const medId = med.id || Date.now() + Math.random();
            
            return {
                id: medId,
                medication: { name: med.name },
                administrationType: med.–∞–¥–º–∏–Ω–∏—Å—Ç—ÄationType,
                dosage: med.dosage,
                hasDiluent: med.diluents && med.diluents.length > 0 ? '–¥–∞' : '–Ω–µ—Ç',
                diluents: med.diluents || []
            };
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        selectedDays = {};
        
        if (scheme.schedule) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤ –≤ Set –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ UI
            Object.entries(scheme.schedule).forEach(([medId, weeks]) => {
                selectedDays[medId] = {};
                
                Object.entries(weeks).forEach(([week, days]) => {
                    selectedDays[medId][week] = new Set(days);
                });
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã —Å –ø–æ–º–µ—Ç–∫–æ–π, —á—Ç–æ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ü–∏—è
        isCreatingNewScheme = true;
        currentEditingScheme = scheme;
        validationError = '';
    }
</script>

<div class="treatment-scheme-container">
    <button 
        on:click={toggleModal} 
        class="treatment-scheme-button"
        style="--bg-color: {mainButtonBgColor}; --text-color: {mainButtonTextColor}; --border-radius: {mainButtonBorderRadius};"
    >
        üìã –°—Ö–µ–º–∞ –ª–µ—á–µ–Ω–∏—è
    </button>

    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
    <TreatmentModal
        isOpen={isModalOpen}
        onClose={toggleModal}
        maxWidth={modalMaxWidth}
        backgroundColor={modalBgColor}
        borderRadius={modalBorderRadius}
        overlayColor={modalOverlayColor}
    >
        <div class="modal-grid">
            <div class="medication-form-column">
                {#if !isCreatingNewScheme}
                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ö–µ–º -->
                    <ExistingSchemes 
                        schemes={existingSchemes}
                        onSelect={selectExistingScheme}
                        onEdit={editExistingScheme}
                        bgColor={schemesBgColor}
                        titleColor={schemesTitleColor}
                        borderColor={schemesBorderColor}
                    />

                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã -->
                    <CreateSchemeButton 
                        onClick={startNewScheme}
                        buttonBgColor={createButtonBgColor}
                        buttonTextColor={createButtonTextColor}
                        buttonHoverColor={createButtonHoverColor}
                        buttonBorderRadius={createButtonBorderRadius}
                    />
                {:else}
                    <h2>
                        {#if currentEditingScheme}
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã: {currentEditingScheme.name}
                        {:else}
                        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
                        {/if}
                    </h2>
                    
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∞ -->
                    <select 
                        bind:value={medicationForm.medication}
                        class="form-control"
                    >
                        {#each medications as med}
                            <option value={med}>{med.name}</option>
                        {/each}
                    </select>

                    <div class="administration-type">
                        <label>
                            <input 
                                type="radio" 
                                value="–≤/–º"
                                bind:group={medicationForm.administrationType}
                            > 
                            –í–Ω—É—Ç—Ä–∏–º—ã—à–µ—á–Ω–æ
                        </label>
                        <label>
                            <input 
                                type="radio" 
                                value="–≤/–≤"
                                bind:group={medicationForm.administrationType}
                            > 
                            –í–Ω—É—Ç—Ä–∏–≤–µ–Ω–Ω–æ
                        </label>
                    </div>

                    <input 
                        type="text" 
                        placeholder="–î–æ–∑–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞"
                        bind:value={medicationForm.dosage}
                        class="form-control"
                    />
                    
                    <div class="diluent-choice">
                        <label>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—å:</label>
                        <label>
                            <input 
                                type="radio" 
                                value="–Ω–µ—Ç"
                                bind:group={medicationForm.hasDiluent}
                            > 
                            –ù–µ—Ç
                        </label>
                        <label>
                            <input 
                                type="radio" 
                                value="–¥–∞"
                                bind:group={medicationForm.hasDiluent}
                            > 
                            –î–∞
                        </label>
                    </div>
                    
                    <!-- –ë–ª–æ–∫ —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª–µ–π -->
                    {#if medicationForm.hasDiluent === '–¥–∞'}
                        <div class="diluents-container">
                            {#each medicationForm.diluents as diluent (diluent.id)}
                                <div class="diluent-row">
                                    <select 
                                        bind:value={diluent.type}
                                        class="form-control diluent-select"
                                    >
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—å</option>
                                        <option value="–≥–ª—é–∫–æ–∑–∞">–ì–ª—é–∫–æ–∑–∞</option>
                                        <option value="—Ñ–∏–∑—Ä–∞—Å—Ç–≤–æ—Ä">–§–∏–∑—Ä–∞—Å—Ç–≤–æ—Ä</option>
                                    </select>
                    
                                    <input 
                                        type="text" 
                                        placeholder="–î–æ–∑–∏—Ä–æ–≤–∫–∞"
                                        bind:value={diluent.dosage}
                                        class="form-control diluent-dosage"
                                    />
                                    
                                    <button 
                                        class="btn-remove-diluent"
                                        on:click={() => removeDiluent(diluent.id)}
                                    >
                                        ‚úñ
                                    </button>
                                </div>
                            {/each}
                            
                            <button 
                                class="btn-add-diluent" 
                                on:click={addDiluent}
                            >
                                + –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—å
                            </button>
                        </div>
                    {/if}

                    <button 
                        class="btn-add" 
                        disabled={!isFormValid}
                        on:click={addMedication}
                    >
                        {editingMedicationId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç'}
                    </button>
                {/if}
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–µ–º–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ -->
            {#if isCreatingNewScheme && selectedMedications.length > 0}
                <div class="schedule-column">
                    <h2>–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–µ–º–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤</h2>
                    
                    <div class="schedule-table">
                        <div class="schedule-header">
                            <div class="medication-column">–ü—Ä–µ–ø–∞—Ä–∞—Ç</div>
                            {#each [1,2,3,4,5,6,7,8,9,10] as day}
                                <div class="day-header">{day}</div>
                            {/each}
                        </div>
                        {#each selectedMedications as medication (medication.id)}
                            <div class="schedule-row {!selectedDays[medication.id] || !Object.values(selectedDays[medication.id]).some(daySet => daySet.size > 0) ? 'error-highlight' : ''}">
                                <div class="medication-cell">
                                    <div class="medication-title">
                                        <strong>{medication.medication.name}</strong> {medication.administrationType}, {medication.dosage}
                                        {#if medication.hasDiluent === '–¥–∞' && medication.diluents.length > 0}
                                            {#each medication.diluents as diluent}
                                                + {diluent.type} ({diluent.dosage}) 
                                            {/each}
                                        {/if}
                                    </div>
                                    <div class="medication-actions">
                                        <button class="btn-edit-medication" on:click={() => editMedication(medication)}>
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn-delete-medication" on:click={() => deleteMedication(medication.id)}>
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                {#each [1,2,3,4,5,6,7,8,9,10] as day}
                                    <div 
                                        class="schedule-cell" 
                                        on:click={() => toggleDay(medication.id, 1, day)}
                                        class:selected={selectedDays[medication.id] && 
                                                        selectedDays[medication.id][1] && 
                                                        selectedDays[medication.id][1].has(day)}
                                    ></div>
                                {/each}
                            </div>
                        {/each}
                    </div>

                    <button 
                        class="btn-continue" 
                        disabled={selectedMedications.length === 0 || isLoading || !isScheduleValid}
                        on:click={publishTreatmentScheme}
                    >
                    {#if isLoading}
                      <span class="spinner"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                    {:else}
                      –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ö–µ–º—É
                    {/if}
                  </button>
                </div>
            {/if}
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        {#if validationError}
            <div class="validation-error">
                ‚ö†Ô∏è {validationError}
            </div>
        {/if}
    </TreatmentModal>
</div>

<style>
    .treatment-scheme-button {
        background-color: var(--bg-color, #007bff);
        color: var(--text-color, white);
        border: none;
        padding: 8px 12px;
        border-radius: var(--border-radius, 4px);
        cursor: pointer;
        transition: opacity 0.2s ease;
    }

    .treatment-scheme-button:hover {
        opacity: 0.9;
    }

    .modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .medication-form-column {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .schedule-column {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-control {
        width: 100%;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    .administration-type, .diluent-choice {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }

    .administration-type label, 
    .diluent-choice label {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .schedule-table {
        border: 1px solid #ddd;
    }

    .schedule-header {
        display: grid;
        grid-template-columns: 400px repeat(10, 1fr);
        background-color: #f0f0f0;
        text-align: center;
    }

    .day-header, .medication-column {
        padding: 5px;
        border-right: 1px solid #ddd;
    }

    .schedule-row {
        display: grid;
        grid-template-columns: 400px repeat(10, 1fr);
    }

    .medication-cell {
        gap: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        border-right: 1px solid #ddd;
        background-color: #f8f9fa;
    }

    .schedule-cell {
        width: 50px;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .schedule-cell:hover {
        background-color: rgba(0,123,255,0.1);
    }

    .schedule-cell.selected {
        background-color: #007bff;
    }

    .btn-add, .btn-continue {
        background-color: #2196F3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-add:disabled, .btn-continue:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .diluents-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }

    .diluent-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .diluent-select {
        flex: 3;
    }

    .diluent-dosage {
        flex: 2;
    }

    .btn-remove-diluent {
        background: #dc3545;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .btn-add-diluent {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        align-self: flex-start;
    }
    
    .error-highlight .medication-cell {
        background-color: #fff4f4;
        border-left: 3px solid #dc3545;
    }

    .validation-error {
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        border-left: 4px solid #ffc107;
        font-size: 14px;
    }
    
    .medication-actions {
        margin-top: 5px;
        display: flex;
        gap: 5px;
    }

    .btn-edit-medication, .btn-delete-medication {
        padding: 2px 5px;
        font-size: 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        background-color: transparent;
    }

    .btn-edit-medication:hover {
        background-color: #f0f0f0;
    }

    .btn-delete-medication:hover {
        background-color: #fff5f5;
    }
    
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>